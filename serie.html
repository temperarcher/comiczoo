<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Serie</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family:Arial; background:#f4f6f8; padding:20px; }
.card { background:#fff; padding:15px; margin:10px 0; border-radius:8px; }
input,select,button { width:100%; padding:8px; margin:5px 0; }
</style>
</head>
<body>

<a href="index.html">⬅ Torna alla vetrina</a>
<h1 id="serieTitle"></h1>

<div class="card">
<input id="search" placeholder="Cerca fumetto">
</div>

<div class="card">
<input id="numero" placeholder="Numero / Nome">
<input id="anno" placeholder="Anno">
<select id="stato">
  <option>Mint</option>
  <option>Near Mint</option>
  <option>Good</option>
  <option>Fair</option>
  <option>Discreto</option>
</select>
<select id="possesso">
  <option value="celo">Ce l'ho</option>
  <option value="manca">Manca</option>
</select>
<button id="add">Aggiungi</button>
</div>

<div id="fumetti"></div>

<script>
// FIREBASE
const firebaseConfig={
  apiKey:"AIzaSyCMWWtqeymGjCxQiQbGcIEZUAEkhaUt-TI",
  authDomain:"comiczoo.firebaseapp.com",
  projectId:"comiczoo"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(), db=firebase.firestore();

const serieId=new URLSearchParams(window.location.search).get("id");
const fumettiDiv=document.getElementById("fumetti");

auth.onAuthStateChanged(async u=>{
  if(!u) return location.href="index.html";

  const s=await db.collection("serie").doc(serieId).get();
  serieTitle.textContent=s.data().titolo;

  loadFumetti();
});

function loadFumetti(){
  db.collection("fumetti")
    .where("uid","==",auth.currentUser.uid)
    .where("serieId","==",serieId)
    .onSnapshot(snap=>{
      fumettiDiv.innerHTML="";
      snap.forEach(d=>{
        const f=d.data();
        if(search.value && !f.numero.toLowerCase().includes(search.value.toLowerCase())) return;

        fumettiDiv.innerHTML+=`
          <div class="card">
            <b>${f.numero}</b> (${f.anno})<br>
            ${f.stato} • ${f.possesso}
          </div>`;
      });
    });
}

add.onclick=async()=>{
  await db.collection("fumetti").add({
    uid:auth.currentUser.uid,
    serieId,
    numero:numero.value,
    anno:anno.value,
    stato:stato.value,
    possesso:possesso.value
  });
  numero.value=anno.value="";
};

search.oninput=loadFumetti;
</script>
</body>
</html>
