<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Collezione Fumetti</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f4f6f8;
    margin: 0;
    padding: 20px;
}
h1, h2 {
    text-align: center;
}
.container {
    max-width: 900px;
    margin: auto;
}
.card {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
input, button {
    padding: 8px;
    margin: 5px 0;
}
button {
    cursor: pointer;
}
.stats {
    display: flex;
    gap: 10px;
    justify-content: space-around;
    flex-wrap: wrap;
}
.stat {
    background: #e8eef3;
    padding: 10px;
    border-radius: 6px;
}
.fumetto img {
    max-width: 100px;
}
.badge {
    padding: 4px 8px;
    border-radius: 5px;
    color: white;
    font-size: 12px;
}
.letto { background: green; }
.nonletto { background: orange; }
</style>
</head>

<body>
<div class="container">

<h1>üìö Collezione Fumetti</h1>

<div id="auth" class="card">
    <h2>Login / Registrazione</h2>
    <input type="email" id="email" placeholder="Email"><br>
    <input type="password" id="password" placeholder="Password"><br>
    <button onclick="signup()">Registrati</button>
    <button onclick="login()">Accedi</button>
</div>

<div id="app" style="display:none;">
    <button onclick="logout()">Logout</button>

    <div class="card">
        <h2>Aggiungi / Modifica fumetto</h2>
        <input id="titolo" placeholder="Titolo"><br>
        <input id="autore" placeholder="Autore"><br>
        <input id="anno" placeholder="Anno"><br>
        <input id="editore" placeholder="Editore"><br>
        <input id="copertina" placeholder="Link copertina"><br>
        <label>
            <input type="checkbox" id="letto"> Letto
        </label><br>
        <button id="salvaBtn" onclick="aggiungiFumetto()">Salva</button>
    </div>

    <div class="card">
        <h2>üìä Statistiche</h2>
        <div class="stats" id="statistiche"></div>
    </div>

    <div class="card">
        <h2>üîç Ricerca</h2>
        <input id="ricerca" placeholder="Titolo o autore" oninput="mostraFumetti()">
    </div>

    <div id="fumetti"></div>
</div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCMWWtqeymGjCxQiQbGcIEZUAEkhaUt-TI",
  authDomain: "comiczoo.firebaseapp.com",
  projectId: "comiczoo",
  storageBucket: "comiczoo.firebasestorage.app",
  messagingSenderId: "854173216358",
  appId: "1:854173216358:web:3b0485ceab341046f907a7"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let editId = null;

// AUTH
function signup() {
  auth.createUserWithEmailAndPassword(
    email.value, password.value
  ).catch(e => alert(e.message));
}
function login() {
  auth.signInWithEmailAndPassword(
    email.value, password.value
  ).catch(e => alert(e.message));
}
function logout() {
  auth.signOut();
}

auth.onAuthStateChanged(user => {
  auth.style.display = user ? "none" : "block";
  app.style.display = user ? "block" : "none";
  if(user) mostraFumetti();
});

// CRUD
function aggiungiFumetto() {
  const data = {
    userId: auth.currentUser.uid,
    titolo: titolo.value,
    autore: autore.value,
    anno: anno.value,
    editore: editore.value,
    copertina: copertina.value,
    letto: letto.checked
  };

  if(editId){
    db.collection("fumetti").doc(editId).set(data);
    editId = null;
    salvaBtn.textContent = "Salva";
  } else {
    db.collection("fumetti").add(data);
  }
  document.querySelectorAll("input").forEach(i => i.type==="checkbox" ? i.checked=false : i.value="");
}

function mostraFumetti() {
  const search = ricerca.value.toLowerCase();
  db.collection("fumetti")
    .where("userId","==",auth.currentUser.uid)
    .onSnapshot(snap => {
      fumetti.innerHTML="";
      let tot=0, letti=0, nonletti=0, editori={};

      snap.forEach(doc => {
        const f = doc.data();
        if(!f.titolo.toLowerCase().includes(search) &&
           !f.autore.toLowerCase().includes(search)) return;

        tot++;
        f.letto ? letti++ : nonletti++;
        editori[f.editore] = (editori[f.editore]||0)+1;

        fumetti.innerHTML += `
        <div class="card fumetto">
          <h3>${f.titolo}</h3>
          <p>${f.autore} ‚Ä¢ ${f.anno} ‚Ä¢ ${f.editore}</p>
          <span class="badge ${f.letto?'letto':'nonletto'}">
            ${f.letto?'Letto':'Non letto'}
          </span>
          ${f.copertina?`<img src="${f.copertina}">`:""}
          <br>
          <button onclick="modifica('${doc.id}')">Modifica</button>
          <button onclick="elimina('${doc.id}')">Elimina</button>
        </div>`;
      });

      let html = `
        <div class="stat">üìö Totale: ${tot}</div>
        <div class="stat">‚úÖ Letti: ${letti}</div>
        <div class="stat">‚è≥ Non letti: ${nonletti}</div>`;
      for(let e in editori){
        html += `<div class="stat">üì¶ ${e}: ${editori[e]}</div>`;
      }
      statistiche.innerHTML = html;
    });
}

function elimina(id){
  if(confirm("Eliminare?"))
    db.collection("fumetti").doc(id).delete();
}

function modifica(id){
  db.collection("fumetti").doc(id).get().then(d=>{
    const f=d.data();
    titolo.value=f.titolo;
    autore.value=f.autore;
    anno.value=f.anno;
    editore.value=f.editore;
    copertina.value=f.copertina;
    letto.checked=f.letto;
    editId=id;
    salvaBtn.textContent="Aggiorna";
  });
}
</script>
</body>
</html>
