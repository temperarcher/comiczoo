<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>ComicZoo</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family: Arial; background:#f4f6f8; padding:20px; }
.card { background:#fff; padding:15px; border-radius:8px; margin-bottom:10px; }
input, select, button { width:100%; padding:8px; margin:5px 0; }
button { cursor:pointer; }

.stelle-gold { color: gold; }
.stelle-gray { color: #999; }
.stelle-red  { color: red; }

.grayscale { filter: grayscale(100%); }
</style>
</head>

<body>

<h1>ðŸ“š ComicZoo</h1>

<!-- AUTH -->
<div id="auth" class="card">
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button id="loginBtn">Login</button>
  <button id="signupBtn">Registrati</button>
</div>

<!-- APP -->
<div id="app" style="display:none">

  <div class="card">
    <input id="ricerca" placeholder="Cerca per titolo...">

    <input id="titolo" placeholder="Titolo fumetto">
    <input id="giorno" type="number" min="1" max="31" placeholder="Giorno">
    <input id="mese" type="number" min="1" max="12" placeholder="Mese">
    <input id="anno" type="number" placeholder="Anno">

    <select id="possesso">
      <option value="Celo">Celo</option>
      <option value="Manca">Manca</option>
    </select>

    <select id="stato">
      <option value="Mint">Mint</option>
      <option value="Near Mint">Near Mint</option>
      <option value="Good">Good</option>
      <option value="Fair">Fair</option>
      <option value="Discreto">Discreto</option>
    </select>

    <input id="copertina" placeholder="URL copertina (opzionale)">

    <button id="saveBtn">Salva</button>
    <button id="logoutBtn">Logout</button>
  </div>

  <div id="lista"></div>
</div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyCMWWtqeymGjCxQiQbGcIEZUAEkhaUt-TI",
  authDomain: "comiczoo.firebaseapp.com",
  projectId: "comiczoo"
});

const auth = firebase.auth();
const db = firebase.firestore();

/* ================= DOM ================= */
const authDiv = document.getElementById("auth");
const appDiv  = document.getElementById("app");
const lista   = document.getElementById("lista");
const ricercaInput = document.getElementById("ricerca");

/* ================= AUTH ================= */
loginBtn.onclick = () => {
  auth.signInWithEmailAndPassword(email.value, password.value)
    .then(u => console.log("Login riuscito", u.user.email))
    .catch(e => alert("Errore login: " + e.message));
};

signupBtn.onclick = () => {
  auth.createUserWithEmailAndPassword(email.value, password.value)
    .then(u => console.log("Registrazione riuscita", u.user.email))
    .catch(e => alert("Errore registrazione: " + e.message));
};

logoutBtn.onclick = () => auth.signOut();

auth.onAuthStateChanged(user => {
  authDiv.style.display = user ? "none" : "block";
  appDiv.style.display  = user ? "block" : "none";
  if (user) {
    try { loadFumetti(); }
    catch(err){ console.error("Errore loadFumetti:", err); }
  }
});

/* ================= STELLE (â˜…) ================= */
function stelle(stato) {
  if (!stato) return "";
  const map = {
    "Mint":       { n:5, c:"stelle-gold" },
    "Near Mint": { n:4, c:"stelle-gray" },
    "Good":       { n:3, c:"stelle-gray" },
    "Fair":       { n:2, c:"stelle-red" },
    "Discreto":   { n:1, c:"stelle-red" }
  };
  const s = map[stato];
  return `<span class="${s.c}">${"â˜…".repeat(s.n)}</span>`;
}

/* ================= SALVA ================= */
saveBtn.onclick = async () => {
  if (!auth.currentUser) return;

  const g = parseInt(document.getElementById("giorno").value);
  const m = parseInt(document.getElementById("mese").value);
  const a = parseInt(document.getElementById("anno").value);
  if (!g || !m || !a) { alert("Inserisci giorno, mese e anno!"); return; }

  try {
    await db.collection("fumetti").add({
      uid: auth.currentUser.uid,
      titolo: document.getElementById("titolo").value,
      possesso: document.getElementById("possesso").value,
      stato: document.getElementById("possesso").value === "Celo" ? document.getElementById("stato").value : null,
      copertina: document.getElementById("copertina").value || "",
      dataPubblicazione: new Date(a, m-1, g)
    });
    document.getElementById("titolo").value = "";
    document.getElementById("giorno").value = "";
    document.getElementById("mese").value = "";
    document.getElementById("anno").value = "";
    document.getElementById("copertina").value = "";
    loadFumetti();
  } catch(err) {
    console.error("Errore salvataggio:", err);
  }
};

/* ================= LOAD ================= */
let tuttiFumetti = [];

function safeDate(value) {
  if (!value) return null;
  if (value.toDate) return value.toDate();
  if (value instanceof Date) return value;
  return null;
}

function loadFumetti() {
  lista.innerHTML = "";
  tuttiFumetti = [];

  db.collection("fumetti")
    .where("uid", "==", auth.currentUser.uid)
    .get()
    .then(snapshot => {
      snapshot.forEach(doc => {
        const f = doc.data();
        f.id = doc.id;
        tuttiFumetti.push(f);
      });
      mostraLista();
    })
    .catch(err => console.error("Errore caricamento fumetti:", err));
}

/* ================= MOSTRA LISTA FILTRATA ================= */
function mostraLista() {
  const query = ricercaInput.value.toLowerCase();
  lista.innerHTML = "";

  tuttiFumetti.forEach(f => {
    if (!f.titolo.toLowerCase().includes(query)) return;

    const d = safeDate(f.dataPubblicazione);
    const dataStr = d ? `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getFullYear()}` : "Data mancante";

    lista.innerHTML += `
      <div class="card">
        <strong>${f.titolo}</strong><br>
        ${dataStr} â€¢ ${f.possesso}<br>
        Stato: ${stelle(f.stato)}<br>
        ${f.copertina ? `<img src="${f.copertina}" class="${f.possesso==="Manca"?"grayscale":""}" width="120">` : ""}
      </div>
    `;
  });
}

ricercaInput.addEventListener("input", mostraLista);

</script>

</body>
</html>
