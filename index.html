<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>ComicZoo ‚Äì Collezione</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
.dark{background:#1e1e1e;color:#eee}
.card{background:#fff;padding:15px;border-radius:8px;margin:10px 0}
.dark .card{background:#2a2a2a}
button,input,select{padding:8px;margin:4px 0;width:100%}
.collapse{cursor:pointer;font-weight:bold}
.content{display:none;margin-left:15px}
img{max-width:80px;border-radius:4px;cursor:pointer}
.gray{filter:grayscale(100%)}
.stat{display:inline-block;margin:5px;padding:6px;background:#ddd;border-radius:6px}
.dark .stat{background:#444}
#popup{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:none;justify-content:center;align-items:center}
#popupImg{max-width:90%;max-height:90%;border-radius:8px}
</style>
</head>
<body>

<h1>üìö ComicZoo</h1>

<!-- LOGIN -->
<div id="auth" class="card">
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<button onclick="register()">Registrati</button>
</div>

<!-- APP -->
<div id="app" style="display:none">
<button onclick="logout()">Logout</button>
<button onclick="toggleDark()">üåô Dark</button>

<!-- Form Nuovo Fumetto -->
<div class="card">
<div class="collapse" onclick="toggle(this)">‚ûï Nuovo fumetto</div>
<div class="content">
<input id="titolo" placeholder="Titolo">
<input id="serie" placeholder="Serie">
<input id="editore" placeholder="Editore">
<input id="codice" placeholder="Codice Editore">
<input id="giorno" placeholder="Giorno">
<input id="mese" placeholder="Mese">
<input id="anno" placeholder="Anno">
<input id="copertina" placeholder="URL copertina">
<select id="possesso" onchange="toggleStato()">
<option>In mio possesso</option>
<option>Manca</option>
</select>
<select id="stato">
<option>Mint</option>
<option>Near Mint</option>
<option>Good</option>
<option>Fair</option>
<option>Discreto</option>
</select>
<button onclick="salvaFumetto()">Salva</button>
</div>
</div>

<!-- Import CSV -->
<div class="card">
<div class="collapse" onclick="toggle(this)">üì• Import CSV</div>
<div class="content">
<input type="file" id="csv">
<button onclick="importCSV()">Importa</button>
</div>
</div>

<!-- Export CSV -->
<div class="card">
<button onclick="exportCSV()">üíæ Export CSV</button>
</div>

<h3>Lista fumetti:</h3>
<div id="list"></div>

<div id="popup" onclick="this.style.display='none'">
<img id="popupImg">
</div>

<script>
/* üî• FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyCMWWtqeymGjCxQiQbGcIEZUAEkhaUt-TI",
  authDomain: "comiczoo.firebaseapp.com",
  projectId: "comiczoo"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

/* LOGIN / REGISTER / LOGOUT */
function login(){auth.signInWithEmailAndPassword(email.value,password.value).catch(e=>alert(e.message))}
function register(){auth.createUserWithEmailAndPassword(email.value,password.value).catch(e=>alert(e.message))}
function logout(){auth.signOut()}

/* DARK MODE */
function toggleDark(){document.body.classList.toggle("dark")}

/* COLLAPSIBILE */
function toggle(el){el.nextElementSibling.style.display = el.nextElementSibling.style.display==="block"?"none":"block"}

/* STATO DISABLED SE NON POSSIEDO */
function toggleStato(){stato.disabled = possesso.value==="Manca"}

/* STELLE PER STATO */
function stars(s){
  if(!s) return "";
  const m={Mint:[5,"gold"],"Near Mint":[4,"white"],Good:[3,"white"],Fair:[2,"red"],Discreto:[1,"red"]};
  return `<span style="color:${m[s][1]}">${"‚≠ê".repeat(m[s][0])}</span>`;
}

/* AUTH STATE */
auth.onAuthStateChanged(user=>{
  const authDiv=document.getElementById("auth");
  const appDiv=document.getElementById("app");
  if(!authDiv || !appDiv){console.error("DIV mancanti"); return;}
  if(user){
    authDiv.style.display="none";
    appDiv.style.display="block";
    loadFumettiRealtime(); // realtime listener
  } else {
    authDiv.style.display="block";
    appDiv.style.display="none";
  }
});

/* SALVA FUMETTO */
async function salvaFumetto(){
  const d=new Date(anno.value, mese.value-1, giorno.value);
  await db.collection("fumetti").add({
    uid: auth.currentUser.uid,
    titolo: titolo.value,
    serie: serie.value,
    editore: editore.value,
    codice: codice.value,
    data: d,
    copertina: copertina.value,
    possesso: possesso.value,
    stato: possesso.value==="In mio possesso"?stato.value:null
  });
  // reset
  titolo.value=serie.value=editore.value=codice.value=giorno.value=mese.value=anno.value=copertina.value="";
  possesso.value="In mio possesso";
  stato.value="Mint";
}

/* LISTA IN TEMPO REALE */
function loadFumettiRealtime(){
  const user = auth.currentUser;
  if(!user) return;
  db.collection("fumetti")
    .where("uid","==",user.uid)
    .onSnapshot(snap=>{
      renderFumetti(snap);
    });
}

/* RENDER FUMETTI */
function renderFumetti(snap){
  const list=document.getElementById("list");
  list.innerHTML="";
  const map={};
  snap.forEach(doc=>{
    const f=doc.data();
    map[f.codice]=map[f.codice]||{};
    map[f.codice][f.editore]=map[f.codice][f.editore]||{};
    map[f.codice][f.editore][f.serie]=map[f.codice][f.editore][f.serie]||[];
    map[f.codice][f.editore][f.serie].push(f);
  });

  for(const c in map){
    const cdiv=document.createElement("div");
    cdiv.className="card";
    cdiv.innerHTML=`<div class="collapse" onclick="toggle(this)">‚ñ∂ ${c}</div><div class="content"></div>`;
    const contentC=cdiv.querySelector(".content");
    for(const e in map[c]){
      const ediv=document.createElement("div");
      ediv.innerHTML=`<div class="collapse" onclick="toggle(this)">‚ñ∂ ${e}</div><div class="content"></div>`;
      const contentE=ediv.querySelector(".content");
      for(const s in map[c][e]){
        const sdiv=document.createElement("div");
        sdiv.innerHTML=`<div class="collapse" onclick="toggle(this)">‚ñ∂ ${s}</div><div class="content"></div>`;
        const contentS=sdiv.querySelector(".content");
        map[c][e][s].sort((a,b)=>{
          let da = a.data && a.data.toDate ? a.data.toDate() : new Date(1970,0,1);
          let db = b.data && b.data.toDate ? b.data.toDate() : new Date(1970,0,1);
          return db - da;
        }).forEach(f=>{
          contentS.innerHTML+=`
          <div class="card">
            <b>${f.titolo}</b><br>
            ${stars(f.stato)} ${f.possesso}<br>
            ${f.copertina?`<img src="${f.copertina}" class="${f.possesso==="Manca"?"gray":""}" onclick="popupImg.src=this.src;popup.style.display='flex'">`:""}
          </div>`;
        });
        contentE.appendChild(sdiv);
      }
      contentC.appendChild(ediv);
    }
    list.appendChild(cdiv);
  }
}

/* EXPORT CSV - CORRETTO */
function exportCSV(){
  db.collection("fumetti").where("uid","==",auth.currentUser.uid).get().then(q=>{
    let c="Titolo,Serie,Editore,Codice,Giorno,Mese,Anno,Possesso,Stato,Copertina\n";
    q.forEach(d=>{
      const f=d.data();
      let dt;
      if(f.data && f.data.toDate){
        dt = f.data.toDate();
      } else if(f.data instanceof Date){
        dt = f.data;
      } else {
        dt = new Date(1970,0,1);
      }
      const day = dt.getDate(), month = dt.getMonth()+1, year = dt.getFullYear();
      c+=`"${f.titolo}","${f.serie}","${f.editore}","${f.codice}",${day},${month},${year},"${f.possesso}","${f.stato||""}","${f.copertina}"\n`;
    });
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([c]));
    a.download="ComicZoo.csv"; a.click();
  }).catch(e=>alert("Errore export CSV: "+e.message));
}

/* IMPORT CSV */
function importCSV(){
  const file = document.getElementById("csv").files[0];
  if(!file){alert("Seleziona un file CSV"); return;}
  const reader = new FileReader();
  reader.onload = async e=>{
    const lines = e.target.result.split("\n");
    for(let i=1;i<lines.length;i++){
      const row = lines[i].split(",");
      if(!row[0]) continue;
      const d = new Date(row[6], row[5]-1, row[4]);
      await db.collection("fumetti").add({
        uid: auth.currentUser.uid,
        titolo: row[0].replace(/"/g,""),
        serie: row[1].replace(/"/g,""),
        editore: row[2].replace(/"/g,""),
        codice: row[3].replace(/"/g,""),
        data: d,
        possesso: row[7].replace(/"/g,""),
        stato: row[7]==="In mio possesso"?row[8].replace(/"/g,""):null,
        copertina: row[9]?row[9].replace(/"/g,""):""
      });
    }
  };
  reader.readAsText(file);
}
</script>

</body>
</html>
