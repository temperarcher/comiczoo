<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ComicZoo ‚Äì Collezione Fumetti</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; margin:0; padding:20px; transition: background 0.3s, color 0.3s; }
h1,h2,h3,h4 { margin:5px 0; }
.container { max-width:900px; margin:auto; }
.card { background:white; border-radius:8px; padding:15px; margin:10px 0; box-shadow:0 2px 5px rgba(0,0,0,0.1); transition: background 0.3s, color 0.3s; }
input,select,button { padding:8px; margin:5px 0; width:100%; }
button { cursor:pointer; }
.stats { display:flex; gap:10px; flex-wrap:wrap; }
.stat { background:#e8eef3; padding:10px; border-radius:6px; transition: background 0.3s, color 0.3s; }
.fumetto img { max-width:100px; margin-top:5px; cursor:pointer; border-radius:4px; }
.badge { padding:4px 8px; border-radius:5px; color:white; font-size:12px; }
.letto { background:green; }
.nonletto { background:orange; }
.serie-header { cursor:pointer; }
.serie-fumetti { margin-left:15px; display:none; }
/* DARK MODE */
body.dark { background:#1f1f1f; color:#f0f0f0; }
body.dark .card { background:#2a2a2a; color:#f0f0f0; }
body.dark .stat { background:#3a3a3a; color:#f0f0f0; }
body.dark input, body.dark select { background:#3a3a3a; color:#f0f0f0; border:1px solid #555; }
/* POPUP COVER */
#coverPopup { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:9999; }
#coverPopup img { max-width:90%; max-height:90%; border-radius:8px; }
</style>
</head>

<body>
<div class="container">

<h1>üìö ComicZoo</h1>

<!-- AUTH -->
<div id="auth" class="card">
  <h2>Login / Registrazione</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <button id="signupBtn">Registrati</button>
  <button id="loginBtn">Accedi</button>
</div>

<!-- APP -->
<div id="app" style="display:none;">
  <button id="logoutBtn">Logout</button>
  <button id="darkBtn">üåô Dark Mode</button>
  <button id="csvBtn">üíæ Esporta CSV</button>

  <div class="card">
    <h2>Aggiungi / Modifica fumetto</h2>
    <input id="titolo" placeholder="Titolo">
    <input id="autore" placeholder="Autore">
    <input id="serie" placeholder="Serie">
    <input id="anno" type="number" placeholder="Anno">
    <input id="editore" placeholder="Editore">
    <input id="copertina" placeholder="Link copertina">
    <label><input type="checkbox" id="letto"> Letto</label>
    <button id="salvaBtn">Salva</button>
  </div>

  <div class="card">
    <h2>üìä Statistiche</h2>
    <div class="stats" id="statistiche"></div>
  </div>

  <div class="card">
    <h2>üîç Ricerca</h2>
    <input id="ricerca" placeholder="Titolo o autore">
    <h2>‚ÜïÔ∏è Ordinamento</h2>
    <select id="ordinamento">
      <option value="anno_asc">Anno ‚Üë</option>
      <option value="anno_desc">Anno ‚Üì</option>
      <option value="serie_asc">Serie A ‚Üí Z</option>
      <option value="serie_desc">Serie Z ‚Üí A</option>
    </select>
  </div>

  <div id="fumetti"></div>
</div>

<!-- POPUP COVER -->
<div id="coverPopup" onclick="this.style.display='none'">
  <img id="coverImg" src="">
</div>

</div>

<script>
window.onload = function(){

// üî• FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyCMWWtqeymGjCxQiQbGcIEZUAEkhaUt-TI",
  authDomain: "comiczoo.firebaseapp.com",
  projectId: "comiczoo",
  storageBucket: "comiczoo.firebasestorage.app",
  messagingSenderId: "854173216358",
  appId: "1:854173216358:web:3b0485ceab341046f907a7"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// DOM
const authDiv = document.getElementById("auth");
const appDiv = document.getElementById("app");
const email = document.getElementById("email");
const password = document.getElementById("password");
const signupBtn = document.getElementById("signupBtn");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const darkBtn = document.getElementById("darkBtn");
const csvBtn = document.getElementById("csvBtn");

const salvaBtn = document.getElementById("salvaBtn");
const titolo = document.getElementById("titolo");
const autore = document.getElementById("autore");
const serie = document.getElementById("serie");
const anno = document.getElementById("anno");
const editore = document.getElementById("editore");
const copertina = document.getElementById("copertina");
const letto = document.getElementById("letto");
const ricerca = document.getElementById("ricerca");
const ordinamento = document.getElementById("ordinamento");
const fumetti = document.getElementById("fumetti");
const statistiche = document.getElementById("statistiche");

const coverPopup = document.getElementById("coverPopup");
const coverImg = document.getElementById("coverImg");

let editId = null;

// AUTH
signupBtn.onclick = ()=>{ auth.createUserWithEmailAndPassword(email.value,password.value).catch(e=>alert(e.message)); };
loginBtn.onclick = ()=>{ auth.signInWithEmailAndPassword(email.value,password.value).catch(e=>alert(e.message)); };
logoutBtn.onclick = ()=>{ auth.signOut(); };

// LOGIN / LOGOUT UI
auth.onAuthStateChanged(user=>{
  if(user){
    authDiv.style.display="none";
    appDiv.style.display="block";
    mostraFumetti();
  }else{
    authDiv.style.display="block";
    appDiv.style.display="none";
  }
});

// DARK MODE
darkBtn.onclick = ()=>{ document.body.classList.toggle("dark"); };

// SALVA / AGGIORNA
salvaBtn.onclick = async function(){
  if(!auth.currentUser){ alert("Non sei loggato"); return; }
  if(!titolo.value || !autore.value){ alert("Titolo e Autore obbligatori"); return; }

  const data = {
    userId: auth.currentUser.uid,
    titolo: titolo.value,
    autore: autore.value,
    serie: serie.value || "",
    anno: anno.value ? parseInt(anno.value) : null,
    editore: editore.value || "",
    copertina: copertina.value || "",
    letto: letto.checked
  };

  try{
    if(editId){
      await db.collection("fumetti").doc(editId).set(data);
      editId=null;
      salvaBtn.textContent="Salva";
    }else{
      await db.collection("fumetti").add(data);
    }
    [titolo,autore,serie,anno,editore,copertina].forEach(i=>i.value="");
    letto.checked=false;
    mostraFumetti();
  } catch(err){
    alert("Errore salvataggio: "+err.message);
    console.error(err);
  }
};

// COLLAPSIBLE SERIE
window.toggleSerie = function(id){
  const div = document.getElementById(id);
  div.style.display = div.style.display==="none"?"block":"none";
};

// MOSTRA + ORDINA
function mostraFumetti(){
  if(!auth.currentUser) return;
  const search = ricerca.value.toLowerCase();
  const ordine = ordinamento.value;
  let query = db.collection("fumetti").where("userId","==",auth.currentUser.uid);

  if(ordine==="anno_asc") query=query.orderBy("anno","asc");
  if(ordine==="anno_desc") query=query.orderBy("anno","desc");
  if(ordine==="serie_asc") query=query.orderBy("serie","asc");
  if(ordine==="serie_desc") query=query.orderBy("serie","desc");

  query.get().then(snap=>{
    fumetti.innerHTML="";
    let tot=0,letti=0,nonletti=0,editori={};
    let serieMap={};

    snap.forEach(doc=>{
      const f=doc.data();
      if(!f.titolo.toLowerCase().includes(search) && !f.autore.toLowerCase().includes(search)) return;
      tot++; f.letto?letti++:nonletti++;
      editori[f.editore]=(editori[f.editore]||0)+1;
      const serieKey=f.serie||"Senza Serie";
      if(!serieMap[serieKey]) serieMap[serieKey]=[];
      serieMap[serieKey].push({id: doc.id,data: f});
    });

    // genera DOM
    for(let s in serieMap){
      const serieId=s.replace(/\s+/g,'_');
      fumetti.innerHTML += `<div class="card">
        <h3 class="serie-header" onclick="toggleSerie('${serieId}')">‚ñ∂Ô∏è ${s}</h3>
        <div id="${serieId}" class="serie-fumetti"></div>
      </div>`;
      const serieDiv=document.getElementById(serieId);
      serieMap[s].forEach(f=>{
        serieDiv.innerHTML += `<div class="card fumetto">
          <h4>${f.data.titolo}</h4>
          <p>${f.data.autore} ‚Ä¢ ${f.data.anno}</p>
          <span class="badge ${f.data.letto?'letto':'nonletto'}">${f.data.letto?'Letto':'Non letto'}</span><br>
          ${f.data.copertina?`<img src="${f.data.copertina}" onclick="showCover('${f.data.copertina}')">`:""}
          <br>
          <button onclick="modifica('${f.id}')">Modifica</button>
          <button onclick="elimina('${f.id}')">Elimina</button>
        </div>`;
      });
    }

    // statistiche
    let html=`<div class="stat">üìö Totale: ${tot}</div>
              <div class="stat">‚úÖ Letti: ${letti}</div>
              <div class="stat">‚è≥ Non letti: ${nonletti}</div>`;
    for(let e in editori) html+=`<div class="stat">üì¶ ${e}: ${editori[e]}</div>`;
    statistiche.innerHTML=html;
  });
}

// ELIMINA
window.elimina = function(id){ if(confirm("Eliminare questo fumetto?")) db.collection("fumetti").doc(id).delete(); };

// MODIFICA
window.modifica = function(id){
  db.collection("fumetti").doc(id).get().then(d=>{
    const f=d.data();
    titolo.value=f.titolo;
    autore.value=f.autore;
    serie.value=f.serie;
    anno.value=f.anno;
    editore.value=f.editore;
    copertina.value=f.copertina;
    letto.checked=f.letto;
    editId=id;
    salvaBtn.textContent="Aggiorna";
  });
};

// Ricerca / Ordinamento
ricerca.oninput=mostraFumetti;
ordinamento.onchange=mostraFumetti;

// CSV
csvBtn.onclick=function(){
  if(!auth.currentUser) return;
  db.collection("fumetti").where("userId","==",auth.currentUser.uid).get().then(snap=>{
    let csv="Titolo,Autore,Serie,Anno,Editore,Letto,Copertina\n";
    snap.forEach(doc=>{
      const f=doc.data();
      csv += `"${f.titolo}","${f.autore}","${f.serie||""}",${f.anno},"${f.editore}","${f.letto}","${f.copertina}"\n`;
    });
    const blob = new Blob([csv],{type:"text/csv"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download="ComicZoo.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  });
};

// SHOW COVER POPUP
window.showCover=function(url){
  coverImg.src=url;
  coverPopup.style.display="flex";
};

};
</script>
</body>
</html>
