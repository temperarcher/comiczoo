<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>ComicZoo</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
.dark{background:#1e1e1e;color:#eee}
.card{background:#fff;padding:15px;border-radius:8px;margin:10px 0}
.dark .card{background:#2a2a2a}
input,select,button{width:100%;padding:8px;margin:4px 0}
.collapse{cursor:pointer;font-weight:bold}
.content{display:none;margin-left:15px}
img{max-width:80px;border-radius:4px;cursor:pointer}
.gray{filter:grayscale(100%)}
#popup{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center}
#popup img{max-width:90%;max-height:90%}
</style>
</head>

<body>

<h1>üìö ComicZoo</h1>

<!-- AUTH -->
<div id="auth" class="card">
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<button onclick="register()">Registrati</button>
</div>

<!-- APP -->
<div id="app" style="display:none">
<button onclick="logout()">Logout</button>
<button onclick="toggleDark()">üåô Dark</button>

<div class="card">
<div class="collapse" onclick="toggle(this)">‚ûï Nuovo fumetto</div>
<div class="content">
<input id="titolo" placeholder="Titolo">
<input id="serie" placeholder="Serie">
<input id="editore" placeholder="Casa editrice">
<input id="codice" placeholder="Codice editore">

<input id="giorno" placeholder="Giorno">
<input id="mese" placeholder="Mese">
<input id="anno" placeholder="Anno">

<input id="copertina" placeholder="URL copertina">

<select id="possesso" onchange="toggleStato()">
<option>In mio possesso</option>
<option>Manca</option>
</select>

<select id="stato">
<option>Mint</option>
<option>Near Mint</option>
<option>Good</option>
<option>Fair</option>
<option>Discreto</option>
</select>

<button onclick="salva()">Salva</button>
</div>
</div>

<h3>Collezione</h3>
<div id="lista"></div>
</div>

<div id="popup" onclick="this.style.display='none'">
<img id="popupImg">
</div>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyCMWWtqeymGjCxQiQbGcIEZUAEkhaUt-TI",
  authDomain: "comiczoo.firebaseapp.com",
  projectId: "comiczoo"
});
const auth=firebase.auth();
const db=firebase.firestore();

/* AUTH */
function login(){auth.signInWithEmailAndPassword(email.value,password.value)}
function register(){auth.createUserWithEmailAndPassword(email.value,password.value)}
function logout(){auth.signOut()}

/* UI */
function toggle(el){el.nextElementSibling.style.display=
  el.nextElementSibling.style.display==="block"?"none":"block"}
function toggleDark(){document.body.classList.toggle("dark")}
function toggleStato(){stato.disabled=possesso.value==="Manca"}

/* STELLE */
function stars(s){
  if(!s) return "";
  const m={Mint:[5,"gold"],"Near Mint":[4,"white"],Good:[3,"white"],Fair:[2,"red"],Discreto:[1,"red"]};
  return `<span style="color:${m[s][1]}">${"‚≠ê".repeat(m[s][0])}</span>`;
}

/* AUTH STATE */
auth.onAuthStateChanged(u=>{
  auth.style.display=u?"none":"block";
  app.style.display=u?"block":"none";
  if(u) load();
});

/* SALVA */
async function salva(){
  const d=new Date(anno.value,mese.value-1,giorno.value);
  await db.collection("fumetti").add({
    uid:auth.currentUser.uid,
    titolo:titolo.value,
    serie:serie.value,
    editore:editore.value,
    codice:codice.value,
    data:d,
    copertina:copertina.value,
    possesso:possesso.value,
    stato:possesso.value==="In mio possesso"?stato.value:null
  });
  load();
}

/* LOAD */
async function load(){
  lista.innerHTML="";
  const snap=await db.collection("fumetti")
    .where("uid","==",auth.currentUser.uid)
    .orderBy("data","desc")
    .get();

  const map={};
  snap.forEach(d=>{
    const f=d.data();
    map[f.codice]??={};
    map[f.codice][f.editore]??={};
    map[f.codice][f.editore][f.serie]??=[];
    map[f.codice][f.editore][f.serie].push(f);
  });

  for(const c in map){
    const cdiv=box(c);
    for(const e in map[c]){
      const ediv=box(e);
      for(const s in map[c][e]){
        const sdiv=box(s);
        map[c][e][s].forEach(f=>{
          sdiv.querySelector(".content").innerHTML+=`
          <div class="card">
            <b>${f.titolo}</b><br>
            ${stars(f.stato)} ${f.possesso}<br>
            ${f.copertina?`<img src="${f.copertina}" class="${f.possesso==="Manca"?"gray":""}"
            onclick="popupImg.src=this.src;popup.style.display='flex'">`:""}
          </div>`;
        });
        ediv.querySelector(".content").appendChild(sdiv);
      }
      cdiv.querySelector(".content").appendChild(ediv);
    }
    lista.appendChild(cdiv);
  }
}

function box(t){
  const d=document.createElement("div");
  d.className="card";
  d.innerHTML=`<div class="collapse" onclick="toggle(this)">‚ñ∂ ${t}</div><div class="content"></div>`;
  return d;
}
</script>
</body>
</html>
