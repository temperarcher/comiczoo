<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>ComicZoo ‚Äì Firestore Minimo</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
body{font-family:Arial;background:#f4f6f8;padding:40px}
.card{background:white;padding:20px;max-width:400px;margin:auto;border-radius:8px;margin-bottom:10px}
input,button{width:100%;padding:10px;margin:6px 0}
#app{display:none}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="auth" class="card">
<h2>Login ComicZoo</h2>
<input id="email" type="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<button onclick="register()">Registrati</button>
</div>

<!-- APP -->
<div id="app" class="card">
<h2>‚úÖ Sei loggato</h2>

<input id="titolo" placeholder="Titolo fumetto">
<button onclick="salvaFumetto()">Salva fumetto</button>

<h3>Lista fumetti:</h3>
<div id="list"></div>

<button onclick="logout()">Logout</button>
</div>

<script>
/* üî• FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyCMWWtqeymGjCxQiQbGcIEZUAEkhaUt-TI",
  authDomain: "comiczoo.firebaseapp.com",
  projectId: "comiczoo"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

/* LOGIN / REGISTER / LOGOUT */
function login(){
  auth.signInWithEmailAndPassword(email.value,password.value)
      .catch(e=>alert(e.message));
}
function register(){
  auth.createUserWithEmailAndPassword(email.value,password.value)
      .catch(e=>alert(e.message));
}
function logout(){auth.signOut()}

/* AUTH STATE */
auth.onAuthStateChanged(user=>{
  const authDiv = document.getElementById("auth");
  const appDiv  = document.getElementById("app");
  if(!authDiv || !appDiv){console.error("DIV mancanti");return;}
  if(user){
    authDiv.style.display="none";
    appDiv.style.display="block";
    loadFumetti();
  }else{
    authDiv.style.display="block";
    appDiv.style.display="none";
  }
});

/* SALVA FUMETTO */
async function salvaFumetto(){
  const t=titolo.value.trim();
  if(!t){alert("Inserisci titolo"); return;}
  try{
    await db.collection("fumetti").add({
      uid: auth.currentUser.uid,
      titolo: t,
      created: firebase.firestore.FieldValue.serverTimestamp()
    });
    titolo.value="";
    loadFumetti();
  }catch(e){alert(e.message);}
}

/* CARICA FUMETTI */
async function loadFumetti(){
  const list=document.getElementById("list");
  list.innerHTML="";
  try{
    const snap=await db.collection("fumetti")
                        .where("uid","==",auth.currentUser.uid)
                        .orderBy("created","desc")
                        .get();
    snap.forEach(doc=>{
      const f=doc.data();
      const d = f.created ? f.created.toDate().toLocaleString() : "-";
      const div=document.createElement("div");
      div.textContent = f.titolo + " (" + d + ")";
      list.appendChild(div);
    });
  }catch(e){
    if(e.code==="failed-precondition"){
      console.warn("Firestore richiede un indice. Segui il link in console per crearlo.");
      console.error(e.message);
      list.innerHTML = "‚ö†Ô∏è Firestore richiede un indice. Controlla console.";
    } else alert(e.message);
  }
}
</script>

</body>
</html>
