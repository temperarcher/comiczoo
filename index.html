<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comic Archive Pro - V7.5 - Ordine Cronologico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        .comic-image { transition: filter 0.5s ease, transform 0.5s ease, opacity 0.5s ease; }
        .comic-card:hover .grayscale { filter: grayscale(0); opacity: 1; }
        .filter-btn.active, .view-btn.active { background-color: #eab308; color: #0f172a; border-color: #eab308; }
        input, select { color-scheme: dark; }
        .serie-showcase-item { transition: transform 0.3s ease, border-color 0.3s ease; width: 120px; }
        .serie-showcase-item:hover { transform: translateY(-4px); border-color: #eab308; }
        .codice-item { transition: all 0.3s ease; cursor: pointer; }
        .codice-item.active { border-color: #eab308; background: #eab30820; }
        .codice-item-square { width: 48px; height: 48px; }
        .list-view-container { display: flex; flex-direction: column; gap: 0.5rem; }
        .list-view-item { display: flex; flex-direction: row; height: 80px !important; align-items: center; }
        .list-view-item .comic-image { width: 60px !important; height: 80px !important; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen font-sans flex flex-col">

    <header class="bg-slate-800 border-b border-slate-700 p-4 sticky top-0 z-50 shadow-2xl">
        <div class="container mx-auto flex flex-col md:flex-row gap-4 items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="bg-yellow-500 text-slate-900 p-2 rounded-lg font-black italic tracking-tighter">CAP</div>
                <h1 class="text-xl font-black uppercase tracking-tighter">Comic Archive <span class="text-yellow-500">Pro</span></h1>
            </div>
            
            <div class="relative w-full md:w-96">
                <input type="text" id="serie-search" placeholder="Cerca una serie..." class="w-full bg-slate-900 border border-slate-700 p-3 rounded-xl text-sm focus:ring-2 focus:ring-yellow-500 outline-none transition-all">
                <div id="serie-results" class="absolute top-full left-0 right-0 bg-slate-800 border border-slate-700 mt-2 rounded-xl shadow-2xl hidden z-50 max-h-64 overflow-y-auto custom-scrollbar"></div>
            </div>

            <div class="flex gap-2">
                <button onclick="openAddModal()" class="bg-yellow-500 hover:bg-yellow-400 text-slate-900 px-6 py-3 rounded-xl font-bold text-sm transition-all shadow-lg active:scale-95">＋ NUOVO ALBO</button>
            </div>
        </div>
    </header>

    <div class="bg-slate-800/50 border-b border-slate-700/50 overflow-x-auto custom-scrollbar">
        <div class="container mx-auto flex items-center gap-4 p-4 min-w-max" id="codici-bar">
            </div>
    </div>

    <main class="container mx-auto p-4 md:p-6 flex-grow">
        <div class="flex flex-col md:flex-row gap-4 items-center justify-between mb-8">
            <div id="serie-showcase" class="flex gap-3 overflow-x-auto custom-scrollbar pb-2 w-full">
                </div>
        </div>

        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 bg-slate-800/30 p-4 rounded-2xl border border-slate-700/30">
            <div class="flex items-center gap-6">
                <h2 id="view-title" class="text-2xl font-black uppercase tracking-tight">Ultimi Arrivi</h2>
                <div id="stats-count" class="bg-slate-700 text-slate-300 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest">0 fumetti</div>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="flex bg-slate-900 p-1 rounded-xl border border-slate-700">
                    <button id="view-grid" onclick="setView('grid')" class="view-btn active px-4 py-2 rounded-lg text-xs font-bold transition-all">GRID</button>
                    <button id="view-list" onclick="setView('list')" class="view-btn px-4 py-2 rounded-lg text-xs font-bold transition-all">LIST</button>
                </div>
                <div class="flex bg-slate-900 p-1 rounded-xl border border-slate-700">
                    <button id="btn-all" onclick="setFilter('all')" class="filter-btn active px-4 py-2 rounded-lg text-xs font-bold transition-all">TUTTI</button>
                    <button id="btn-celo" onclick="setFilter('celo')" class="filter-btn px-4 py-2 rounded-lg text-xs font-bold transition-all text-green-500">CE L'HO</button>
                    <button id="btn-manca" onclick="setFilter('manca')" class="filter-btn px-4 py-2 rounded-lg text-xs font-bold transition-all text-red-400">MANCA</button>
                </div>
            </div>
        </div>

        <div id="comic-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-6">
            </div>
    </main>

    <footer class="bg-slate-800 border-t border-slate-700 p-4 mt-8">
        <div class="container mx-auto text-center text-slate-500 text-[10px] font-bold uppercase tracking-widest">
            versione 7.5 - ordine cronologico (data_pubblicazione)
        </div>
    </footer>

    <div id="edit-modal" class="fixed inset-0 bg-slate-950/90 backdrop-blur-sm hidden z-[100] p-4 flex items-center justify-center">
        <div class="bg-slate-800 w-full max-w-5xl rounded-3xl shadow-2xl border border-slate-700 overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                <h3 id="modal-title" class="text-xl font-black uppercase tracking-tighter">Dettagli Albo</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white transition-colors text-2xl">✕</button>
            </div>
            
            <form id="edit-form" class="flex flex-col md:flex-row overflow-hidden">
                <input type="hidden" id="edit-id">
                
                <div class="w-full md:w-1/3 p-6 bg-slate-900/50 border-r border-slate-700 flex flex-col gap-6 overflow-y-auto custom-scrollbar">
                    <div class="aspect-[2/3] bg-slate-950 rounded-xl overflow-hidden shadow-2xl border border-slate-700 relative group">
                        <img id="edit-preview" src="" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center p-4">
                            <p class="text-[10px] text-yellow-500 font-bold uppercase text-center">Anteprima Copertina</p>
                        </div>
                    </div>

                    <div class="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-[10px] font-black uppercase tracking-widest text-slate-400">Storie Contenute</h4>
                            <button type="button" onclick="openStorieModal()" class="bg-blue-500/10 text-blue-400 text-[9px] px-2 py-1 rounded font-bold hover:bg-blue-500/20 uppercase transition-all">＋ Aggiungi</button>
                        </div>
                        <div id="issue-stories-list" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar">
                            </div>
                    </div>
                </div>

                <div class="flex-grow p-8 overflow-y-auto custom-scrollbar grid grid-cols-1 md:grid-cols-2 gap-6 bg-slate-800">
                    <div class="md:col-span-2">
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Serie</label>
                            <div class="flex gap-2">
                                <button type="button" id="btn-edit-serie-context" onclick="openEditSerieFromContext()" disabled class="text-[9px] bg-blue-500/10 text-blue-400 px-2 py-0.5 rounded hover:bg-blue-500/20 transition-all font-bold uppercase">✏️ Edit</button>
                                <button type="button" onclick="openSerieModal()" class="text-[9px] bg-yellow-500/10 text-yellow-500 px-2 py-0.5 rounded hover:bg-yellow-500/20 transition-all font-bold uppercase">+ Nuova</button>
                            </div>
                        </div>
                        <select id="edit-serie_id" required onchange="handleSerieChange(this.value)" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-sm font-bold text-white outline-none focus:ring-1 focus:ring-yellow-500"></select>
                    </div>

                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Titolo Albo</label>
                        <input type="text" id="edit-nome" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg mt-1 text-sm font-bold text-white outline-none focus:ring-1 focus:ring-yellow-500">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Numero</label>
                            <input type="text" id="edit-numero" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg mt-1 text-sm font-black text-yellow-500 outline-none focus:ring-1 focus:ring-yellow-500">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Possesso</label>
                            <select id="edit-possesso" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg mt-1 text-sm font-bold text-white outline-none focus:ring-1 focus:ring-yellow-500">
                                <option value="celo">CE L'HO</option>
                                <option value="manca">MANCA</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Data Pubbl.</label>
                            <input type="date" id="edit-data_pubblicazione" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg mt-1 text-sm font-bold text-white outline-none">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Tipo Pubbl.</label>
                            <select id="edit-tipo_pubblicazione_id" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg mt-1 text-sm font-bold text-white outline-none"></select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Valore (€)</label>
                            <input type="number" step="0.01" id="edit-valore" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg mt-1 text-sm font-bold text-white outline-none">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Condizione (1-5)</label>
                            <input type="number" min="1" max="5" id="edit-condizione" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg mt-1 text-sm font-bold text-white outline-none">
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Annata</label>
                            <div class="flex gap-2">
                                <button type="button" id="btn-edit-annata-issue" onclick="openEditAnnataFromIssue()" disabled class="text-[9px] bg-blue-500/10 text-blue-400 px-2 py-0.5 rounded hover:bg-blue-500/20 transition-all font-bold uppercase">✏️ Edit</button>
                                <button type="button" onclick="openAnnataModal()" class="text-[9px] bg-yellow-500/10 text-yellow-500 px-2 py-0.5 rounded hover:bg-yellow-500/20 transition-all font-bold uppercase">+ Nuova</button>
                            </div>
                        </div>
                        <select id="edit-annata_id" onchange="document.getElementById('btn-edit-annata-issue').disabled = !this.value" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-sm font-bold text-white outline-none"></select>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Collana</label>
                            <div class="flex gap-2">
                                <button type="button" id="btn-edit-collana-issue" onclick="openEditCollanaFromIssue()" disabled class="text-[9px] bg-blue-500/10 text-blue-400 px-2 py-0.5 rounded hover:bg-blue-500/20 transition-all font-bold uppercase">✏️ Edit</button>
                                <button type="button" onclick="openCollanaModal()" class="text-[9px] bg-yellow-500/10 text-yellow-500 px-2 py-0.5 rounded hover:bg-yellow-500/20 transition-all font-bold uppercase">+ Nuova</button>
                            </div>
                        </div>
                        <select id="edit-collana_id" disabled class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-sm font-bold text-white outline-none opacity-50"></select>
                    </div>

                    <div class="md:col-span-2">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">URL Immagine</label>
                        <input type="text" id="edit-immagine_url" oninput="document.getElementById('edit-preview').src = this.value" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg mt-1 text-[10px] text-blue-400 outline-none focus:ring-1 focus:ring-yellow-500 font-mono">
                    </div>

                    <div class="md:col-span-2 flex gap-3 pt-4 border-t border-slate-700 mt-2">
                        <button type="submit" class="flex-grow bg-yellow-500 hover:bg-yellow-400 text-slate-900 py-4 rounded-xl font-black uppercase tracking-widest transition-all shadow-xl active:scale-95">Salva Albo</button>
                        <button type="button" onclick="closeModal()" class="px-8 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-bold uppercase text-[10px] tracking-widest transition-all">Annulla</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="serie-modal" class="fixed inset-0 bg-slate-950/90 backdrop-blur-sm hidden z-[110] p-4 flex items-center justify-center">
        <div class="bg-slate-800 w-full max-w-lg rounded-3xl border border-slate-700 shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center">
                <h3 id="serie-modal-title" class="text-lg font-black uppercase tracking-widest">Dettagli Serie</h3>
                <button onclick="closeSerieModal()" class="text-slate-400 hover:text-white transition-colors">✕</button>
            </div>
            <form id="serie-form" class="p-6 space-y-4">
                <input type="hidden" id="new-serie-id">
                <div class="flex gap-4">
                    <div class="w-24 h-32 bg-slate-900 rounded-lg overflow-hidden border border-slate-700 shrink-0">
                        <img id="new-serie-preview" src="" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-grow space-y-4">
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Nome Serie</label>
                            <input type="text" id="new-serie-nome" required class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg mt-1 text-sm font-bold text-white outline-none">
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Collana</label>
                                <button type="button" id="btn-edit-collana-serie" onclick="openEditCollanaFromSerie()" disabled class="text-[9px] bg-blue-500/10 text-blue-400 px-2 py-0.5 rounded font-bold uppercase">✏️ Edit</button>
                            </div>
                            <select id="new-serie-collana" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-sm font-bold text-white outline-none"></select>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">URL Logo / Immagine</label>
                    <input type="text" id="new-serie-immagine" oninput="document.getElementById('new-serie-preview').src = this.value" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg mt-1 text-xs text-blue-400 outline-none font-mono">
                </div>
                <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-400 text-slate-900 py-4 rounded-xl font-black uppercase tracking-widest transition-all mt-4">Salva Serie</button>
            </form>
        </div>
    </div>

    <div id="storie-modal" class="fixed inset-0 bg-slate-950/90 backdrop-blur-sm hidden z-[120] p-4 flex items-center justify-center">
        <div class="bg-slate-800 w-full max-w-4xl rounded-3xl border border-slate-700 shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center bg-slate-800/80">
                <h3 id="storie-modal-title" class="text-lg font-black uppercase tracking-widest text-blue-400">Gestione Storia</h3>
                <button onclick="closeStorieModal()" class="text-slate-400 hover:text-white transition-colors">✕</button>
            </div>
            
            <div class="flex flex-col md:flex-row overflow-hidden">
                <div class="w-full md:w-1/2 p-6 border-r border-slate-700 bg-slate-900/30 flex flex-col">
                    <div class="flex justify-between items-center mb-6">
                        <h4 class="text-[10px] font-black uppercase tracking-[0.2em] text-yellow-500/70">Personaggi in questa storia</h4>
                        <button type="button" onclick="openAddPersonaggioStoriaModal()" class="bg-yellow-500 text-slate-900 text-[9px] px-3 py-1 rounded-full font-black uppercase hover:bg-yellow-400 transition-all">＋ Associa</button>
                    </div>
                    <div id="lista-personaggi-storia" class="space-y-3 overflow-y-auto custom-scrollbar flex-grow pr-2">
                        </div>
                </div>

                <form id="storie-form" class="w-full md:w-1/2 p-8 space-y-6">
                    <input type="hidden" id="storie-id">
                    <input type="hidden" id="old-storia-id">
                    
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-2">Titolo Storia</label>
                        <input type="text" id="storie-nome" list="storie-esistenti" required class="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl text-sm font-bold text-white outline-none focus:ring-1 focus:ring-blue-500">
                        <datalist id="storie-esistenti"></datalist>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-2">Associa ad Albo</label>
                            <select id="storie-issue-id" onchange="togglePosizioneField(this.value)" class="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl text-[11px] font-bold text-white outline-none"></select>
                        </div>
                        <div id="storie-posizione-container" class="hidden">
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-2">Posizione</label>
                            <input type="number" id="storie-posizione" class="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl text-sm font-bold text-white outline-none">
                        </div>
                    </div>

                    <div class="pt-6 border-t border-slate-700 flex gap-3">
                        <button type="submit" class="flex-grow bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-black uppercase tracking-widest transition-all shadow-lg">Salva Storia</button>
                        <button type="button" onclick="closeStorieModal()" class="px-6 bg-slate-700 text-slate-300 rounded-xl font-bold uppercase text-[10px] tracking-widest">Chiudi</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="personaggio-storia-modal" class="fixed inset-0 bg-slate-950/95 backdrop-blur-md hidden z-[130] p-4 flex items-center justify-center">
        <div class="bg-slate-800 w-full max-w-md rounded-2xl border border-yellow-500/30 shadow-2xl p-6">
            <h3 class="text-sm font-black uppercase tracking-[0.2em] text-yellow-500 mb-6 border-b border-slate-700 pb-4">Associa Personaggio</h3>
            <form id="personaggio-storia-form" class="space-y-5">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">Seleziona Personaggio</label>
                    <select id="ps-personaggio-id" required class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-sm text-white outline-none"></select>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">Conferma Storia</label>
                    <select id="ps-storia-id" required class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-sm text-white outline-none"></select>
                </div>
                <div class="flex gap-2 pt-4">
                    <button type="submit" class="flex-grow bg-yellow-500 text-slate-900 py-3 rounded-lg font-black uppercase text-xs tracking-widest hover:bg-yellow-400 transition-all">Conferma Link</button>
                    <button type="button" onclick="closeAddPersonaggioStoriaModal()" class="px-4 bg-slate-700 text-slate-300 rounded-lg font-bold text-[10px] uppercase">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <div id="simple-modal" class="fixed inset-0 bg-slate-950/90 backdrop-blur-sm hidden z-[150] p-4 flex items-center justify-center">
        <div class="bg-slate-800 w-full max-w-md rounded-3xl border border-slate-700 shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center">
                <h3 id="simple-modal-title" class="text-sm font-black uppercase tracking-widest text-yellow-500">Gestione Voce</h3>
                <button onclick="closeSimpleModal()" class="text-slate-400 hover:text-white transition-colors">✕</button>
            </div>
            <form id="simple-form" class="p-6">
                <input type="hidden" id="simple-id">
                <div id="simple-preview-container" class="mb-4 hidden">
                    <div class="w-20 h-20 bg-slate-900 rounded-lg border border-slate-700 mx-auto overflow-hidden">
                        <img id="simple-preview-img" src="" class="w-full h-full object-contain">
                    </div>
                </div>
                <div id="simple-form-fields" class="space-y-4"></div>
                <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-400 text-slate-900 py-4 rounded-xl font-black uppercase tracking-widest transition-all mt-6 active:scale-95 shadow-lg">Salva Modifiche</button>
            </form>
        </div>
    </div>

    <script src="scripts.js"></script>
</body>
</html>